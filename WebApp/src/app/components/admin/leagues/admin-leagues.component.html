<div class="admin-container">
  <section class="fade-in">
    <div class="admin-header-row">
      <h1 class="section-title">League Automation Management</h1>
      <div class="header-buttons">
        <button class="modal-action-btn order-btn" (click)="toggleOrderMode()">
          {{ isPositionOrder ? 'Active Order' : 'Position Order' }}
          <ng-icon name="jamGrid" size="20"></ng-icon>
        </button>
        <button class="modal-action-btn settings-btn" (click)="openGeneralModal()">
          Settings
          <ng-icon name="jamSettingsAlt" size="20"></ng-icon>
        </button>
      </div>
    </div>
    <p class="section-description">Configure automatic match updates for each league</p>
    
    <div class="leagues-list">
          @for (leaguesSetting of (isPositionOrder ? sortedLeaguesByPosition : leaguesSettings); track $index) {
        <div class="league-row" [ngClass]="{
          'league-inactive': !leaguesSetting.is_active,
          'league-daily-update': leaguesSetting.is_active && leaguesSetting.daily_update
        }">
          <div class="league-info">
            <div class="league-header-info">
              <img 
                class="league-logo" 
                [src]="images.getRouteImageLeagueSm(leaguesSetting.league_id)"
                [alt]="leaguesSetting.league_name + ' logo'">
              <div class="league-text">
                <h3 class="league-name">{{leaguesSetting.league_name}}</h3>
                <span class="league-id">#{{leaguesSetting.league_id}}</span>
              </div>
            </div>
                </div>
          
          <div class="league-controls">
            <div class="control-group">
              <label class="control-label">Status</label>
              <div class="status-control">
                <label class="toggle-switch">
                  <input type="checkbox" 
                         [(ngModel)]="leaguesSetting.is_active"
                         (change)="changeIsActive(leaguesSetting.league_id, leaguesSetting.is_active)">
                  <span class="toggle-slider"></span>
                  </label>
                </div>
            </div>

            <div class="control-group">
              <label class="control-label">Frequency</label>
              <div class="frequency-options" [class.disabled]="!leaguesSetting.is_active">
                <label class="frequency-option" *ngFor="let freq of [1, 3, 7, 30]">
                  <input type="radio" 
                         name="frequency{{$index}}" 
                         [value]="freq"
                         [(ngModel)]="leaguesSetting.update_frequency"
                         [disabled]="!leaguesSetting.is_active"
                         (change)="changeUpdateFrequency(leaguesSetting.league_id, freq)">
                  <span class="frequency-label">{{freq}}d</span>
                  </label>
                </div>
            </div>

            <div class="control-group">
              <label class="control-label">Daily Updates</label>
              <div class="daily-update-control">
                <label class="toggle-switch small">
                  <input type="checkbox" 
                         [(ngModel)]="leaguesSetting.daily_update"
                         [disabled]="!leaguesSetting.is_active"
                         (change)="changeDailyUpdate(leaguesSetting.league_id, leaguesSetting.daily_update)">
                  <span class="toggle-slider"></span>
                  </label>
                </div>
            </div>
          </div>

          <div class="league-dates">
            <div class="date-item">
              <span class="date-label">Last Update</span>
              <span class="date-value">{{leaguesSetting.last_update ? (leaguesSetting.last_update | date:'dd/MM/yyyy HH:mm') : '-'}}</span>
            </div>
            <div class="date-item">
              <span class="date-label">Next Match</span>
              <span class="date-value">{{leaguesSetting.next_match ? (leaguesSetting.next_match | date:'dd/MM/yyyy HH:mm') : '-'}}</span>
            </div>
            <div class="date-item">
              <span class="date-label">Last Daily</span>
              <span class="date-value">{{leaguesSetting.last_daily_update ? (leaguesSetting.last_daily_update | date:'dd/MM/yyyy HH:mm') : '-'}}</span>
            </div>
          </div>

          <div class="league-actions">
            <button 
              class="settings-button" 
              (click)="openSettingsModal(leaguesSetting)"
              [attr.aria-label]="'Settings for ' + leaguesSetting.league_name">
              <ng-icon name="jamSettingsAlt" size="20"></ng-icon>
            </button>
          </div>
        </div>
      }
    </div>

    <div class="empty-state" *ngIf="leaguesSettings.length === 0">
      <div class="empty-state-icon">âš½</div>
      <h2 class="empty-state-title">No Leagues Configured</h2>
      <p class="empty-state-description">Leagues will appear here once they are added to the system.</p>
    </div>
  </section>

  <!-- Settings Modal -->
  @if (showSettingsModal) {
    <div class="modal-overlay" (click)="closeSettingsModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div>
            <h2 class="modal-title">League Settings</h2>
            <div *ngIf="selectedLeague" class="modal-league-name">{{selectedLeague.league_name}}</div>
          </div>
          <button class="modal-close" (click)="closeSettingsModal()">
            <ng-icon name="jamClose" size="24"></ng-icon>
          </button>
        </div>
        <div class="modal-body">

          <!-- League Colors Section -->
          <div class="modal-section">
            <h3 class="section-title">League Colors</h3>
            <div class="colors-container">
              <div class="color-input-group">
                <label for="base-color">Base Color</label>
                <div class="color-input-wrapper">
                  <input 
                    type="color" 
                    id="base-color"
                    [(ngModel)]="selectedLeagueBaseColor"
                    (change)="onBaseColorChange()"
                    class="color-picker">
                  <input 
                    type="text" 
                    [(ngModel)]="selectedLeagueBaseColor"
                    (change)="onBaseColorChange()"
                    class="color-text-input"
                    placeholder="#000000">
                </div>
              </div>
              <div class="color-input-group">
                <label for="card-main-color">Card Main Color</label>
                <div class="color-input-wrapper">
                  <input 
                    type="color" 
                    id="card-main-color"
                    [(ngModel)]="selectedLeagueCardMainColor"
                    (change)="onCardMainColorChange()"
                    class="color-picker">
                  <input 
                    type="text" 
                    [(ngModel)]="selectedLeagueCardMainColor"
                    (change)="onCardMainColorChange()"
                    class="color-text-input"
                    placeholder="#000000">
                  <button 
                    type="button"
                    (click)="copyBaseToCardMain()"
                    class="copy-color-btn"
                    title="Copy base color">
                    ðŸ“‹
                  </button>
                </div>
              </div>
              <div class="color-input-group">
                <label for="card-trans-color">Card Transparent Color</label>
                <div class="color-input-wrapper">
                  <input 
                    type="color" 
                    id="card-trans-color"
                    [(ngModel)]="selectedLeagueCardTransColor"
                    (change)="onCardTransColorChange()"
                    class="color-picker">
                  <input 
                    type="text" 
                    [(ngModel)]="selectedLeagueCardTransColor"
                    (change)="onCardTransColorChange()"
                    class="color-text-input"
                    placeholder="rgba(0,0,0,0.9)">
                  <button 
                    type="button"
                    (click)="copyBaseToCardTrans()"
                    class="copy-color-btn"
                    title="Copy base color as rgba">
                    ðŸ“‹
                  </button>
                </div>
              </div>
              <button 
                (click)="saveLeagueColors()"
                [disabled]="isUpdatingColors"
                class="modal-action-btn colors-btn">
                {{ isUpdatingColors ? 'Saving...' : 'Save Colors' }}
              </button>
            </div>
            
            <!-- Preview Section -->
            <div class="preview-section">
              <h4 class="preview-title">Preview</h4>
              <div class="preview-card-wrapper">
                @if (previewMatch) {
                  <app-real-match-card 
                    [match]="previewMatch"
                    [watched]="true"
                    [locations]="[]"
                    [size]="'md'"
                    [interactable]="false">
                  </app-real-match-card>
                }
              </div>
            </div>
          </div>

          <!-- Toggle Button for Update Sections -->
          <div class="modal-section">
            <button 
              (click)="toggleUpdateSections()"
              class="modal-action-btn toggle-updates-btn">
              <span>{{ showUpdateSections ? 'Hide' : 'Show' }} Update Options</span>
              <ng-icon [name]="showUpdateSections ? 'jamChevronUp' : 'jamChevronDown'" size="20"></ng-icon>
            </button>
          </div>

          <!-- Update Sections (Collapsible) -->
          @if (showUpdateSections) {
            <!-- Update Season Section -->
          <div class="modal-section">
            <label for="season-selector">Current Season</label>
            <select id="season-selector" [(ngModel)]="selectedSeason">
              <option *ngFor="let s of shortSeasonsList" [value]="s">{{s}}</option>
            </select>
            <button 
              (click)="triggerUpdateSeason()"
              [disabled]="selectedSeason === selectedLeague?.season || isUpdateSeasonLoading"
              class="modal-action-btn">
              {{ isUpdateSeasonLoading ? 'Updating...' : 'Update' }}
            </button>
          </div>

          <!-- Data Updates Section -->
          <div class="modal-section">
            <label for="data-update-selector">Season for Data Updates</label>
            <div class="data-updates-container">
              <select id="data-update-selector" [(ngModel)]="selectedDataUpdateSeason">
                <option *ngFor="let s of availableSeasonsForSelectedLeague" [value]="s">{{s}}</option>
              </select>
              <div class="update-buttons-grid">
                <button 
                  (click)="triggerMatchesUpdate()"
                  [disabled]="isMatchesUpdateLoading"
                  class="modal-action-btn matches-btn">
                  {{ isMatchesUpdateLoading ? 'Updating...' : 'Matches' }}
                </button>
                <button 
                  (click)="triggerTeamsUpdate()"
                  [disabled]="isUpdateTeamsLoading"
                  class="modal-action-btn teams-btn">
                  {{ isUpdateTeamsLoading ? 'Updating...' : 'Teams' }}
                </button>
                <button 
                  (click)="triggerPlayersUpdate()"
                  [disabled]="isUpdatePlayersLoading"
                  class="modal-action-btn players-btn">
                  {{ isUpdatePlayersLoading ? 'Updating...' : 'Players' }}
                </button>
                <button 
                  (click)="triggerStatisticsUpdate()"
                  [disabled]="isUpdateStatisticsLoading"
                  class="modal-action-btn statistics-btn">
                  {{ isUpdateStatisticsLoading ? 'Updating...' : 'Statistics - Full' }}
                </button>
                <button 
                  (click)="triggerLineupsUpdate()"
                  [disabled]="isUpdateLineupsLoading"
                  class="modal-action-btn lineups-btn">
                  {{ isUpdateLineupsLoading ? 'Updating...' : 'Lineups - Full' }}
                </button>
                <button 
                  (click)="triggerEventsUpdate()"
                  [disabled]="isUpdateEventsLoading"
                  class="modal-action-btn events-btn">
                  {{ isUpdateEventsLoading ? 'Updating...' : 'Events - Full' }}
                </button>
                <button 
                  (click)="triggerStatisticsMissingUpdate()"
                  [disabled]="isUpdateStatisticsMissingLoading"
                  class="modal-action-btn statistics-btn">
                  {{ isUpdateStatisticsMissingLoading ? 'Updating...' : 'Statistics - Missing' }}
                </button>
                <button 
                  (click)="triggerLineupsMissingUpdate()"
                  [disabled]="isUpdateLineupsMissingLoading"
                  class="modal-action-btn lineups-btn">
                  {{ isUpdateLineupsMissingLoading ? 'Updating...' : 'Lineups - Missing' }}
                </button>
                <button 
                  (click)="triggerEventsMissingUpdate()"
                  [disabled]="isUpdateEventsMissingLoading"
                  class="modal-action-btn events-btn">
                  {{ isUpdateEventsMissingLoading ? 'Updating...' : 'Events - Missing' }}
                </button>
              </div>
            </div>
          </div>

          <!-- Multi-Season Update Section -->
          <div class="modal-section">
            <div class="multi-season-container">
              <h3 class="multi-season-title">Multi-Season Update</h3>
              <div class="season-range-container">
                <div class="season-range-item">
                  <label for="season-from-selector">From Season</label>
                  <select id="season-from-selector" [(ngModel)]="selectedSeasonFrom">
                    <option *ngFor="let s of availableSeasonsForSelectedLeague" [value]="s">{{s}}</option>
                  </select>
                </div>
                <div class="season-range-item">
                  <label for="season-to-selector">To Season</label>
                  <select id="season-to-selector" [(ngModel)]="selectedSeasonTo">
                    <option *ngFor="let s of availableSeasonsForSelectedLeague" [value]="s">{{s}}</option>
                  </select>
                </div>
              </div>
              
              <div class="update-options-container">
                <h4 class="update-options-title">Select Updates to Perform:</h4>
                <div class="checkbox-grid">
                  <label class="checkbox-item">
                    <input type="checkbox" [(ngModel)]="multiUpdateOptions.matches">
                    <span class="checkbox-label matches-label">Matches</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" [(ngModel)]="multiUpdateOptions.teams">
                    <span class="checkbox-label teams-label">Teams</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" [(ngModel)]="multiUpdateOptions.players">
                    <span class="checkbox-label players-label">Players</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" [(ngModel)]="multiUpdateOptions.statistics">
                    <span class="checkbox-label statistics-label">Statistics - Full</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" [(ngModel)]="multiUpdateOptions.lineups">
                    <span class="checkbox-label lineups-label">Lineups - Full</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" [(ngModel)]="multiUpdateOptions.events">
                    <span class="checkbox-label events-label">Events - Full</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" [(ngModel)]="multiUpdateOptions.statistics_missing">
                    <span class="checkbox-label statistics-label">Statistics - Missing</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" [(ngModel)]="multiUpdateOptions.lineups_missing">
                    <span class="checkbox-label lineups-label">Lineups - Missing</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" [(ngModel)]="multiUpdateOptions.events_missing">
                    <span class="checkbox-label events-label">Events - Missing</span>
                  </label>
                </div>
              </div>
              
              <div class="multi-update-actions">
                <button 
                  (click)="triggerMultiSeasonUpdate()"
                  [disabled]="isMultiUpdateLoading || !hasSelectedOptions()"
                  class="multi-update-btn">
                  {{ isMultiUpdateLoading ? 'Updating...' : 'Execute Multi-Season Update' }}
                </button>
                <button 
                  (click)="selectAllOptions()"
                  class="select-all-btn">
                  Select All
                </button>
                <button 
                  (click)="deselectAllOptions()"
                  class="deselect-all-btn">
                  Deselect All
                </button>
              </div>
            </div>
          </div>
          }

          <!-- Available Seasons Status Table -->
          <div *ngIf="selectedLeague" class="modal-seasons-status-table">
            <table class="seasons-table">
              <thead>
                <tr>
                  <th class="season-status-year">Season</th>
                  <th class="season-status-matches">Matches</th>
                  <th class="season-status-teams">Teams</th>
                  <th class="season-status-players">Players</th>
                  <th class="season-status-statistics">Statistics</th>
                  <th class="season-status-lineups">Lineups</th>
                  <th class="season-status-events">Events</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let seasonDetail of availableSeasonsDetails">
                  <td class="season-status-year">{{ seasonDetail.season }}</td>
                  <td class="season-status-matches" [ngClass]="{'no-data': seasonDetail.real_matches === null}">
                    {{ seasonDetail.real_matches ? seasonDetail.real_matches : 'No data' }}
                  </td>
                  <td class="season-status-teams" [ngClass]="{'no-data': seasonDetail.teams === null}">
                    {{ seasonDetail.teams ? seasonDetail.teams : 'No data' }}
                  </td>
                  <td class="season-status-players" [ngClass]="{'no-data': seasonDetail.players === null}">
                    {{ seasonDetail.players ? seasonDetail.players : 'No data' }}
                  </td>
                  <td class="season-status-statistics" [ngClass]="{'no-data': seasonDetail.statistics === null}">
                    {{ seasonDetail.statistics ? seasonDetail.statistics : 'No data' }}
                  </td>
                  <td class="season-status-lineups" [ngClass]="{'no-data': seasonDetail.lineups === null}">
                    {{ seasonDetail.lineups ? seasonDetail.lineups : 'No data' }}
                  </td>
                  <td class="season-status-events" [ngClass]="{'no-data': seasonDetail.events === null}">
                    {{ seasonDetail.events ? seasonDetail.events : 'No data' }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  }

  <!-- General Modal for All Leagues Updates -->
  @if (showGeneralModal) {
    <div class="modal-overlay" (click)="closeGeneralModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">All Leagues Update</h2>
          <button class="modal-close" (click)="closeGeneralModal()">
            <ng-icon name="jamClose" size="24"></ng-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="top-buttons-container">
            <div class="button-with-description">
              <button 
                class="modal-action-btn"
                (click)="triggerUpdateLeagues()"
                [disabled]="isUpdateLeaguesLoading">
                {{ isUpdateLeaguesLoading ? 'Updating...' : 'Update All Leagues' }}
              </button>
              <p class="button-description">Trigger API update for all the leagues</p>
            </div>
            
            <div class="button-with-description">
              <button 
                class="modal-action-btn"
                (click)="triggerCheckAvailableSeasons()"
                [disabled]="isCheckSeasonsLoading">
                {{ isCheckSeasonsLoading ? 'Checking...' : 'Check Matches by League and Season' }}
              </button>
              <p class="button-description">Check and correct local data structures of league_settings</p>
            </div>
          </div>

          <!-- Separator -->
          <div class="modal-separator"></div>

          <!-- Add New League Section -->
          <div class="modal-section centered">
            <label for="add-league-selector" class="centered-label">Add New League</label>
            <input 
              type="text" 
              id="league-search" 
              placeholder="Search leagues by ID, name, or country..."
              [(ngModel)]="leagueSearchText"
              (input)="filterLeagues()"
              class="league-search-input">
            <select 
              id="add-league-selector" 
              [(ngModel)]="selectedNewLeague"
              (change)="onLeagueSelectionChange()"
              class="league-select-dropdown">
              <option [ngValue]="null">Choose a league...</option>
              <option *ngFor="let league of filteredLeaguesForAdding" [ngValue]="league">
                #{{league.league.id}} - {{league.league.name}} ({{league.country.name}})
              </option>
            </select>
            <div class="league-action-group">
              <div class="league-count-hint">
                {{ filteredLeaguesForAdding.length }} league{{ filteredLeaguesForAdding.length !== 1 ? 's' : '' }} available
              </div>
              <button 
                (click)="createLeagueSetting()"
                [disabled]="!selectedNewLeague || isCreatingLeagueSetting"
                class="modal-action-btn">
                {{ isCreatingLeagueSetting ? 'Creating...' : 'Add League' }}
              </button>
            </div>
          </div>

          <!-- Separator -->
          <div class="modal-separator"></div>

          <!-- Leagues Position Management Section -->
          <div class="modal-section">
            <label class="centered-label">Leagues Position Management ({{leaguesSettings.length}} leagues)</label>
            
            <div class="leagues-position-table" *ngIf="sortedLeaguesByPosition.length > 0">
              <table class="position-table">
                <thead>
                  <tr>
                    <th>Position</th>
                    <th>League</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let league of sortedLeaguesByPosition; track league?.league_id || i; let i = index">
                    <td class="position-cell">{{league?.position || "--"}}</td>
                    <td class="league-cell">
                      <div class="league-info-row">
                        <img 
                          class="league-logo-small" 
                          [src]="images.getRouteImageLeagueSm(league?.league_id || 0)"
                          [alt]="(league?.league_name || 'League') + ' logo'">
                        <span class="league-name-small">{{league?.league_name || 'Unknown League'}}</span>
                      </div>
                    </td>
                    <td class="actions-cell">
                      <div class="position-actions">
                        <div class="arrow-buttons">
                          <button 
                            class="position-btn up-btn"
                            (click)="moveLeagueUp(league?.league_id || 0)"
                            [disabled]="i === 0 || isMovingLeague || !league?.league_id">
                            <ng-icon name="jamChevronUp" size="16"></ng-icon>
                          </button>
                          <button 
                            class="position-btn down-btn"
                            (click)="moveLeagueDown(league?.league_id || 0)"
                            [disabled]="i === sortedLeaguesByPosition.length - 1 || isMovingLeague || !league?.league_id">
                            <ng-icon name="jamChevronDown" size="16"></ng-icon>
                          </button>
                        </div>
                        <div class="position-input-group">
                          <input 
                            type="number" 
                            class="position-input"
                            [value]="league?.position || (i + 1)"
                            (input)="onPositionInputChange(league?.league_id || 0, $event)"
                            min="1"
                            [placeholder]="'1-' + sortedLeaguesByPosition.length"
                            [title]="'Enter position 1-' + sortedLeaguesByPosition.length + '. Higher values will be set to last position.'"
                            [disabled]="isMovingLeague">
                          <button 
                            class="position-btn apply-btn"
                            (click)="applyPositionChange(league?.league_id || 0)"
                            [disabled]="isMovingLeague || !league?.league_id || !hasPositionChanged(league?.league_id || 0)"
                            title="Apply position change">
                            <ng-icon name="jamArrowRight" size="16"></ng-icon>
                          </button>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  }
</div>
